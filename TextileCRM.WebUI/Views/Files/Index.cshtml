@{
    ViewData["Title"] = "Dosyalar";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="bi bi-folder"></i> Dosya Yönetimi</h2>
                    <p class="text-muted">Faturalar, tasarım dosyaları ve dökümanlar</p>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                    <i class="bi bi-upload"></i> Dosya Yükle
                </button>
            </div>
        </div>
    </div>

    <!-- Kategori Filtreleri -->
    <div class="row mb-3">
        <div class="col-md-4">
            <select id="categoryFilter" class="form-select" onchange="loadFiles()">
                <option value="">Tüm Kategoriler</option>
                <option value="0">Fatura</option>
                <option value="1">Ödeme Makbuzu</option>
                <option value="2">Tasarım Dosyası</option>
                <option value="3">Ürün Resmi</option>
                <option value="4">Sipariş Dökümanı</option>
                <option value="5">Sözleşme</option>
                <option value="6">Diğer</option>
            </select>
        </div>
        <div class="col-md-4">
            <div id="totalSizeInfo" class="alert alert-info mb-0 py-2">
                <i class="bi bi-info-circle"></i> Toplam boyut hesaplanıyor...
            </div>
        </div>
    </div>

    <!-- Dosya Listesi -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="bi bi-file-earmark"></i> Dosya Adı</th>
                                    <th>Kategori</th>
                                    <th>Entity</th>
                                    <th>Boyut</th>
                                    <th>Yüklenme Tarihi</th>
                                    <th class="text-center">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="filesTableBody">
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function loadFiles() {
            const category = document.getElementById('categoryFilter').value;
            const url = category ? `/api/filesapi/category/${category}` : '/api/filesapi';
            
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('filesTableBody');
                    tbody.innerHTML = '';
                    
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Dosya bulunamadı</td></tr>';
                        return;
                    }
                    
                    const categoryMap = ['Fatura', 'Ödeme Makbuzu', 'Tasarım', 'Ürün Resmi', 'Sipariş Dökümanı', 'Sözleşme', 'Diğer'];
                    
                    data.forEach(file => {
                        const sizeMB = (file.fileSize / 1024 / 1024).toFixed(2);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <i class="bi bi-file-earmark-${getFileIcon(file.fileExtension)} text-primary"></i>
                                <strong>${file.originalFileName}</strong>
                            </td>
                            <td><span class="badge bg-secondary">${categoryMap[file.category]}</span></td>
                            <td>${file.entityType} #${file.entityId}</td>
                            <td>${sizeMB} MB</td>
                            <td>${new Date(file.uploadedDate).toLocaleDateString('tr-TR')}</td>
                            <td class="text-center">
                                <a href="/api/filesapi/${file.id}/download" class="btn btn-sm btn-outline-success" download>
                                    <i class="bi bi-download"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteFile(${file.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('filesTableBody').innerHTML = 
                        '<tr><td colspan="6" class="text-center py-4 text-danger">Veriler yüklenemedi</td></tr>';
                });
        }
        
        function loadTotalSize() {
            fetch('/api/filesapi/total-size')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('totalSizeInfo').innerHTML = 
                        `<i class="bi bi-hdd"></i> Toplam Boyut: <strong>${data.totalMB} MB (${data.totalGB} GB)</strong>`;
                })
                .catch(() => {});
        }
        
        function getFileIcon(ext) {
            const iconMap = {
                '.pdf': 'pdf',
                '.doc': 'word',
                '.docx': 'word',
                '.xls': 'excel',
                '.xlsx': 'excel',
                '.jpg': 'image',
                '.jpeg': 'image',
                '.png': 'image',
                '.zip': 'zip'
            };
            return iconMap[ext] || 'text';
        }
        
        function deleteFile(id) {
            if (confirm('Dosyayı silmek istediğinizden emin misiniz?')) {
                fetch(`/api/filesapi/${id}`, { method: 'DELETE' })
                    .then(() => {
                        alert('Dosya silindi');
                        loadFiles();
                        loadTotalSize();
                    })
                    .catch(err => alert('Silme işlemi başarısız'));
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            loadFiles();
            loadTotalSize();
        });
    </script>
}

